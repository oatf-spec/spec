# =============================================================================
# OATF Conformance: Validation Test Suite
# Tests SDK validate() entry point against rules from §11.1.
# =============================================================================

# ---------------------------------------------------------------------------
# V-001: oatf field is present and is a supported version string
# ---------------------------------------------------------------------------

- name: "V-001 valid: oatf field present with supported version"
  id: VAL-001a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-001 invalid: oatf field missing"
  id: VAL-001b
  input: |
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-001"
        path: "oatf"

- name: "V-001 invalid: unsupported version string"
  id: VAL-001c
  input: |
    oatf: "9.9"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-001"
        path: "oatf"

# ---------------------------------------------------------------------------
# V-002: oatf field is the first field in the document
# ---------------------------------------------------------------------------

- name: "V-002 valid: oatf is the first field"
  id: VAL-002a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-002 warning: attack appears before oatf"
  id: VAL-002b
  input: |
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
    oatf: "0.1"
  expected:
    valid: true
    warnings:
      - rule: "W-001"
        path: "oatf"

# ---------------------------------------------------------------------------
# V-003: Exactly one attack object is present
# ---------------------------------------------------------------------------

- name: "V-003 valid: exactly one attack object"
  id: VAL-003a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-003 invalid: attack is an array instead of object"
  id: VAL-003b
  input: |
    oatf: "0.1"
    attack:
      - id: OATF-TEST-001
        name: "Attack One"
      - id: OATF-TEST-002
        name: "Attack Two"
  expected:
    errors:
      - rule: "V-003"
        path: "attack"

# ---------------------------------------------------------------------------
# V-004: Required fields present (only execution is required)
# ---------------------------------------------------------------------------

- name: "V-004 valid: minimal document with only execution"
  id: VAL-004a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
  expected:
    valid: true

- name: "V-004 valid: missing attack.id (now optional)"
  id: VAL-004b
  input: |
    oatf: "0.1"
    attack:
      name: "Test Attack"
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 valid: missing attack.name (now optional)"
  id: VAL-004c
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 valid: missing attack.description (now optional)"
  id: VAL-004d
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 valid: missing severity (now optional)"
  id: VAL-004e
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 invalid: missing execution"
  id: VAL-004f
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      severity: high
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-004"
        path: "attack.execution"

- name: "V-004 valid: missing indicators (now optional)"
  id: VAL-004g
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      severity: high
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-005: All enumeration values are valid
# ---------------------------------------------------------------------------

- name: "V-005 valid: all enumeration values are valid"
  id: VAL-005a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      severity: high
      status: experimental
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-005 invalid: severity level 'extreme' is not a valid enum value"
  id: VAL-005b
  input: |
    oatf: "0.1"
    attack:
      severity: extreme
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.severity"

- name: "V-005 invalid: execution.mode does not match pattern"
  id: VAL-005c
  input: |
    oatf: "0.1"
    attack:
      severity: high
      execution:
        mode: grpc_attacker
        phases:
          - name: phase-1
            state:
              tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.execution.mode"

- name: "V-005 invalid: execution.mode missing _{role} suffix"
  id: VAL-005d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp
        state:
          tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.execution.mode"

- name: "V-005 invalid: status 'published' is not a valid enum value"
  id: VAL-005e
  input: |
    oatf: "0.1"
    attack:
      severity: high
      status: published
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.status"

- name: "V-005 invalid: indicator surface 'invalid_surface' for MCP protocol"
  id: VAL-005f
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: invalid_surface
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-005"
        path: "attack.indicators[0].surface"

- name: "V-005 invalid: correlation.logic 'majority' is not a valid enum value"
  id: VAL-005g
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
      correlation:
        logic: majority
  expected:
    errors:
      - rule: "V-005"
        path: "attack.correlation.logic"

- name: "V-012 invalid: indicator has no detection key"
  id: VAL-005h
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

- name: "V-005 valid: elicitation_responses action 'decline' is valid"
  id: VAL-005i
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_client
        state:
          elicitation_responses:
            - action: decline
      indicators:
        - surface: elicitation_request
          pattern:
            contains: "credentials"
  expected:
    valid: true

- name: "V-005 invalid: elicitation_responses action 'deny' was removed from enum"
  id: VAL-005j
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_client
        state:
          elicitation_responses:
            - action: deny
      indicators:
        - surface: elicitation_request
          pattern:
            contains: "credentials"
  expected:
    errors:
      - rule: "V-005"
        path: "attack.execution.state.elicitation_responses[0].action"

# ---------------------------------------------------------------------------
# V-006: indicators contains at least one entry when present
# ---------------------------------------------------------------------------

- name: "V-006 invalid: indicators is empty array"
  id: VAL-006a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators: []
  expected:
    errors:
      - rule: "V-006"
        path: "attack.indicators"

# ---------------------------------------------------------------------------
# V-007: execution.phases contains at least one entry
# ---------------------------------------------------------------------------

- name: "V-007 invalid: execution.phases is empty array"
  id: VAL-007a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-007"
        path: "attack.execution.phases"

# ---------------------------------------------------------------------------
# V-008: At most one terminal phase, and it is the last phase
# ---------------------------------------------------------------------------

- name: "V-008 valid: terminal phase is the last phase"
  id: VAL-008a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            description: "Terminal phase, no trigger."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-008 invalid: terminal phase is first, non-terminal follows"
  id: VAL-008b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
          - name: phase-2
            trigger:
              event: tools/call
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-008"
        path: "attack.execution.phases[0]"

- name: "V-008 invalid: two terminal phases (neither has trigger)"
  id: VAL-008c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            description: "First terminal phase."
          - name: phase-3
            description: "Second terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-008"
        path: "attack.execution.phases"

- name: "V-008 valid: single phase with no trigger (terminal-only document)"
  id: VAL-008d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: only-phase
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-009: First phase includes state
# ---------------------------------------------------------------------------

- name: "V-009 valid: first phase has state"
  id: VAL-009a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-009 invalid: first phase omits state"
  id: VAL-009b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            description: "No state defined."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-009"
        path: "attack.execution.phases[0]"

# ---------------------------------------------------------------------------
# V-010: All explicitly specified indicator.id values are unique
# ---------------------------------------------------------------------------

- name: "V-010 valid: all indicator IDs unique"
  id: VAL-010a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: IND-01
          surface: tool_description
          pattern:
            contains: "test"
        - id: IND-02
          surface: tool_name
          pattern:
            contains: "evil"
  expected:
    valid: true

- name: "V-010 invalid: duplicate indicator IDs"
  id: VAL-010b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: IND-01
          surface: tool_description
          pattern:
            contains: "test"
        - id: IND-01
          surface: tool_name
          pattern:
            contains: "evil"
  expected:
    errors:
      - rule: "V-010"
        path: "attack.indicators[1].id"

# ---------------------------------------------------------------------------
# V-011: All phase.name values are unique
# ---------------------------------------------------------------------------

- name: "V-011 valid: all phase names unique"
  id: VAL-011a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: setup
            state:
              tools: []
            trigger:
              event: tools/call
          - name: exploit
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-011 invalid: two phases named 'setup'"
  id: VAL-011b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: setup
            state:
              tools: []
            trigger:
              event: tools/call
          - name: setup
            description: "Duplicate name."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-011"
        path: "attack.execution.phases[1].name"

# ---------------------------------------------------------------------------
# V-012: Each indicator has exactly one detection key (pattern/expression/semantic)
# ---------------------------------------------------------------------------

- name: "V-012 valid: indicator has pattern key"
  id: VAL-012a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-012 invalid: indicator has both pattern and expression keys"
  id: VAL-012b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
          expression:
            cel: "true"
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

- name: "V-012 invalid: indicator has both pattern and semantic keys"
  id: VAL-012c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
          semantic:
            intent: "detect injection"
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

- name: "V-012 invalid: indicator with no detection key at all"
  id: VAL-012d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

# ---------------------------------------------------------------------------
# V-013: All regular expressions are syntactically valid RE2
# ---------------------------------------------------------------------------

- name: "V-013 valid: regex pattern is syntactically valid"
  id: VAL-013a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            regex: "id_rsa|passwd"
  expected:
    valid: true

- name: "V-013 invalid: regex with unclosed character class"
  id: VAL-013b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            regex: "[unclosed"
  expected:
    errors:
      - rule: "V-013"
        path: "attack.indicators[0].pattern.regex"

- name: "V-013 invalid: regex in trigger.match predicate is also validated"
  id: VAL-013c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: tools/call
              match:
                arguments.command:
                  regex: "[unclosed"
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-013"
        path: "attack.execution.phases[0].trigger.match.arguments.command.regex"

# ---------------------------------------------------------------------------
# V-014: All CEL expressions are syntactically valid
# ---------------------------------------------------------------------------

- name: "V-014 valid: well-formed CEL expression"
  id: VAL-014b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "message.tools.exists(t, size(t.description) > 100)"
  expected:
    valid: true

- name: "V-014 invalid: CEL expression with unclosed parenthesis"
  id: VAL-014a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "size(message.tools"
  expected:
    errors:
      - rule: "V-014"
        path: "attack.indicators[0].expression.cel"

# ---------------------------------------------------------------------------
# V-015: All JSONPath expressions are syntactically valid
# ---------------------------------------------------------------------------

- name: "V-015 valid: well-formed JSONPath expression"
  id: VAL-015b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            extractors:
              - name: tool_name
                source: request
                type: json_path
                selector: "$.tools[0].name"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-015 invalid: JSONPath with unclosed bracket"
  id: VAL-015a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            extractors:
              - name: broken_path
                source: request
                type: json_path
                selector: "$.tools["
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-015"
        path: "attack.execution.phases[0].extractors[0].selector"

# ---------------------------------------------------------------------------
# V-016: All template references use valid syntax
# ---------------------------------------------------------------------------

- name: "V-016 valid: well-formed template reference"
  id: VAL-016a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
                  response:
                    content:
                      - type: text
                        text: "Result for {{request.arguments.query}}"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-016 invalid: unclosed template reference"
  id: VAL-016b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
                  response:
                    content:
                      - type: text
                        text: "Result for {{unclosed"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-016"
        path: "attack.execution.phases[0].state.tools[0].response.content[0].text"

- name: "V-016 valid: escaped template is not flagged"
  id: VAL-016c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
                  response:
                    content:
                      - type: text
                        text: "Literal \\{{not_a_template}} here"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-017: severity.confidence is in range 0-100
# ---------------------------------------------------------------------------

- name: "V-017 valid: severity.confidence is 75"
  id: VAL-017a
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: 75
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-017 invalid: severity.confidence is -1 (below range)"
  id: VAL-017b
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: -1
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-017"
        path: "attack.severity.confidence"

- name: "V-017 invalid: severity.confidence is 101 (above range)"
  id: VAL-017c
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: 101
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-017"
        path: "attack.severity.confidence"

- name: "V-017 valid: severity.confidence at lower boundary (0)"
  id: VAL-017d
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: low
        confidence: 0
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-017 valid: severity.confidence at upper boundary (100)"
  id: VAL-017e
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: 100
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-018: Indicator surface is valid for the indicator's resolved protocol
# ---------------------------------------------------------------------------

- name: "V-018 valid: MCP indicator with MCP surface"
  id: VAL-018a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-018 invalid: MCP execution with A2A surface agent_card"
  id: VAL-018b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: agent_card
          pattern:
            contains: "malicious"
  expected:
    errors:
      - rule: "V-018"
        path: "attack.indicators[0].surface"

# ---------------------------------------------------------------------------
# V-019: Trigger count and match only present when event is also present
# ---------------------------------------------------------------------------

- name: "V-019 invalid: trigger has count but no event"
  id: VAL-019a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              count: 3
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-019"
        path: "attack.execution.phases[0].trigger"

- name: "V-019 invalid: trigger has match but no event"
  id: VAL-019b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              match:
                arguments.command: "run"
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-019"
        path: "attack.execution.phases[0].trigger"

# ---------------------------------------------------------------------------
# V-030: Execution form mutual exclusivity (state/phases/actors)
# ---------------------------------------------------------------------------

- name: "V-030 invalid: both state and phases present"
  id: VAL-030a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
        phases:
          - name: phase-1
            state:
              tools: []
  expected:
    errors:
      - rule: "V-030"
        path: "attack.execution"

- name: "V-030 invalid: both state and actors present"
  id: VAL-030b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
        actors:
          - name: default
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
  expected:
    errors:
      - rule: "V-030"
        path: "attack.execution"

- name: "V-030 invalid: both phases and actors present"
  id: VAL-030c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
        actors:
          - name: default
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
  expected:
    errors:
      - rule: "V-030"
        path: "attack.execution"

- name: "V-030 invalid: state present but mode absent"
  id: VAL-030d
  input: |
    oatf: "0.1"
    attack:
      execution:
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-030"
        path: "attack.execution.mode"

# ---------------------------------------------------------------------------
# V-031: Multi-actor constraints
# ---------------------------------------------------------------------------

- name: "V-031 valid: actors with unique names and modes"
  id: VAL-031a
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: attacker
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
          - name: observer
            mode: a2a_server
            phases:
              - name: phase-1
                state:
                  agent_card:
                    name: "Agent"
                    description: "An agent"
                    url: "https://example.com"
                    skills: []
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-031 invalid: duplicate actor names"
  id: VAL-031b
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: attacker
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
          - name: attacker
            mode: a2a_server
            phases:
              - name: phase-1
                state:
                  agent_card:
                    name: "Agent"
                    description: "An agent"
                    url: "https://example.com"
                    skills: []
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-031"
        path: "attack.execution.actors[1].name"

- name: "V-031 invalid: actor name does not match pattern"
  id: VAL-031c
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: "Invalid-Name"
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
  expected:
    errors:
      - rule: "V-031"
        path: "attack.execution.actors[0].name"

# ---------------------------------------------------------------------------
# V-036: Mode pattern validation
# ---------------------------------------------------------------------------

- name: "V-036 valid: standard mode pattern"
  id: VAL-036a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-036 valid: unknown but valid mode pattern"
  id: VAL-036b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: custom_proto_server
        state:
          tools: []
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-020: No YAML anchors, aliases, or merge keys
# ---------------------------------------------------------------------------

- name: "V-020 invalid: document uses YAML alias"
  id: VAL-020a
  # NOTE: Test runner must parse this as raw text and detect the alias &anchor/*anchor
  # before YAML resolution. SDKs whose parsers expose anchor info SHOULD flag this.
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state: &anchor
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
    extra: *anchor
  expected:
    errors:
      - rule: "V-020"

# ---------------------------------------------------------------------------
# V-021: Explicit target fields are valid wildcard dot-path syntax
# ---------------------------------------------------------------------------

- name: "V-021 valid: wildcard target tools[*].description"
  id: VAL-021a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
  expected:
    valid: true

- name: "V-021 invalid: target with numeric index tools[0].description"
  id: VAL-021b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            target: "tools[0].description"
            condition:
              contains: "test"
  expected:
    errors:
      - rule: "V-021"
        path: "attack.indicators[0].pattern.target"

- name: "V-021 invalid: target with invalid characters"
  id: VAL-021c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            target: "tools[*].desc!!ion"
            condition:
              contains: "test"
  expected:
    errors:
      - rule: "V-021"
        path: "attack.indicators[0].pattern.target"

# ---------------------------------------------------------------------------
# V-022: semantic.threshold in range [0.0, 1.0]
# ---------------------------------------------------------------------------

- name: "V-022 valid: semantic.threshold 0.5"
  id: VAL-022a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          semantic:
            intent: "Detect injection"
            threshold: 0.5
  expected:
    valid: true

- name: "V-022 invalid: semantic.threshold -0.1"
  id: VAL-022b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          semantic:
            intent: "Detect injection"
            threshold: -0.1
  expected:
    errors:
      - rule: "V-022"
        path: "attack.indicators[0].semantic.threshold"

- name: "V-022 invalid: semantic.threshold 1.1"
  id: VAL-022c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          semantic:
            intent: "Detect injection"
            threshold: 1.1
  expected:
    errors:
      - rule: "V-022"
        path: "attack.indicators[0].semantic.threshold"

- name: "V-022 valid: semantic.threshold 0.0 (lower boundary)"
  id: VAL-022d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          semantic:
            intent: "Detect injection"
            threshold: 0.0
  expected:
    valid: true

- name: "V-022 valid: semantic.threshold 1.0 (upper boundary)"
  id: VAL-022e
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          semantic:
            intent: "Detect injection"
            threshold: 1.0
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-023: attack.id matches pattern ^[A-Z][A-Z0-9-]*-[0-9]{3,}$
# ---------------------------------------------------------------------------

- name: "V-023 valid: attack.id OATF-001"
  id: VAL-023a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-001
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-023 invalid: attack.id lowercase-001"
  id: VAL-023b
  input: |
    oatf: "0.1"
    attack:
      id: lowercase-001
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-023"
        path: "attack.id"

- name: "V-023 invalid: attack.id OATF (missing numeric suffix)"
  id: VAL-023c
  input: |
    oatf: "0.1"
    attack:
      id: OATF
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-023"
        path: "attack.id"

# ---------------------------------------------------------------------------
# V-024: indicator.id matches pattern AND prefix equals attack.id
# ---------------------------------------------------------------------------

- name: "V-024 valid: indicator.id OATF-001-01 matching attack.id OATF-001"
  id: VAL-024a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-001
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: OATF-001-01
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-024 invalid: indicator.id OTHER-001-01 not matching attack.id OATF-001"
  id: VAL-024b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-001
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: OTHER-001-01
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-024"
        path: "attack.indicators[0].id"

- name: "V-024 invalid: indicator.id OATF-001 missing indicator suffix"
  id: VAL-024c
  input: |
    oatf: "0.1"
    attack:
      id: OATF-001
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: OATF-001
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-024"
        path: "attack.indicators[0].id"

# ---------------------------------------------------------------------------
# V-025: indicator.confidence in range 0–100
# ---------------------------------------------------------------------------

- name: "V-025 valid: indicator.confidence 50"
  id: VAL-025a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          confidence: 50
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-025 invalid: indicator.confidence -1"
  id: VAL-025b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          confidence: -1
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-025"
        path: "attack.indicators[0].confidence"

- name: "V-025 invalid: indicator.confidence 101"
  id: VAL-025c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          confidence: 101
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-025"
        path: "attack.indicators[0].confidence"

# ---------------------------------------------------------------------------
# V-026: expression.variables values are valid simple dot-paths
# ---------------------------------------------------------------------------

- name: "V-026 valid: expression variable value tools.name (simple dot-path)"
  id: VAL-026a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "desc.contains('inject')"
            variables:
              desc: "tools.name"
  expected:
    valid: true

- name: "V-026 invalid: expression variable value with wildcard"
  id: VAL-026b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "desc.contains('inject')"
            variables:
              desc: "tools[*].name"
  expected:
    errors:
      - rule: "V-026"
        path: "attack.indicators[0].expression.variables.desc"

# ---------------------------------------------------------------------------
# V-027: MatchPredicate keys are valid simple dot-paths
# ---------------------------------------------------------------------------

- name: "V-027 valid: predicate key arguments.command (simple dot-path)"
  id: VAL-027a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: tools/call
              match:
                arguments.command: "run"
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-027 invalid: predicate key with wildcard"
  id: VAL-027b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: tools/call
              match:
                "args[*].cmd": "run"
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-027"
        path: "attack.execution.phases[0].trigger.match.args[*].cmd"

# ---------------------------------------------------------------------------
# V-028: Mode-less multi-phase: every phase specifies mode, every indicator specifies protocol
# ---------------------------------------------------------------------------

- name: "V-028 valid: mode-less multi-phase, all phases have mode, all indicators have protocol"
  id: VAL-028a
  input: |
    oatf: "0.1"
    attack:
      execution:
        phases:
          - name: phase-1
            mode: mcp_server
            state:
              tools: []
            trigger:
              event: tools/call
          - name: phase-2
            mode: a2a_server
            state:
              agent_card:
                name: "Agent"
                description: "An agent"
                url: "https://example.com"
                skills: []
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-028 invalid: mode-less multi-phase, one phase missing mode"
  id: VAL-028b
  input: |
    oatf: "0.1"
    attack:
      execution:
        phases:
          - name: phase-1
            mode: mcp_server
            state:
              tools: []
            trigger:
              event: tools/call
          - name: phase-2
            state:
              tools: []
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-028"
        path: "attack.execution.phases[1].mode"

- name: "V-028 invalid: execution.mode absent, indicator missing protocol"
  id: VAL-028c
  input: |
    oatf: "0.1"
    attack:
      execution:
        phases:
          - name: phase-1
            mode: mcp_server
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-028"
        path: "attack.indicators[0].protocol"

# ---------------------------------------------------------------------------
# V-029: Trigger event types valid per Event-Mode Validity Matrix
# ---------------------------------------------------------------------------

- name: "V-029 valid: mcp_server trigger event tools/call"
  id: VAL-029a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: tools/call
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-029 invalid: mcp_server trigger event message/send (a2a event)"
  id: VAL-029b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: message/send
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-029"
        path: "attack.execution.phases[0].trigger.event"

- name: "V-029 valid: unknown mode skips event validation"
  id: VAL-029c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: custom_proto_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: custom/event
          - name: phase-2
            description: "Terminal phase."
  expected:
    valid: true

- name: "V-029 valid: mcp_server trigger event notifications/elicitation/complete"
  id: VAL-029d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
              elicitation_requests:
                - message: "Please authenticate."
                  mode: url
                  elicitationId: "elicit-001"
                  url: "https://attacker.example.com/auth"
            trigger:
              event: notifications/elicitation/complete
          - name: phase-2
            description: "Terminal phase — exfiltrate after elicitation completes."
      indicators:
        - surface: server_notification
          pattern:
            target: "params"
            condition:
              contains: "elicit-001"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-032: Cross-actor template references resolve
# ---------------------------------------------------------------------------

- name: "V-032 valid: template references existing actor name"
  id: VAL-032a
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: actor_a
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools:
                    - name: "test"
                      description: "A test tool"
                      inputSchema:
                        type: object
                      response:
                        content:
                          - type: text
                            text: "Result: {{actor_b.extracted_val}}"
                extractors:
                  - name: local_var
                    source: request
                    type: json_path
                    selector: "$.name"
          - name: actor_b
            mode: a2a_server
            phases:
              - name: phase-1
                state:
                  agent_card:
                    name: "Agent"
                    description: "An agent"
                    url: "https://example.com"
                    skills: []
                extractors:
                  - name: extracted_val
                    source: request
                    type: json_path
                    selector: "$.task_id"
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-032 invalid: template references nonexistent actor"
  id: VAL-032b
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: actor_a
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools:
                    - name: "test"
                      description: "A test tool"
                      inputSchema:
                        type: object
                      response:
                        content:
                          - type: text
                            text: "Result: {{nonexistent.var}}"
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-032"
        path: "attack.execution.actors[0].phases[0].state.tools[0].response.content[0].text"

# ---------------------------------------------------------------------------
# V-033: content/messages and synthesize mutually exclusive
# ---------------------------------------------------------------------------

- name: "V-033 valid: MCP tool response with synthesize only"
  id: VAL-033a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: "test"
              description: "A test tool"
              inputSchema:
                type: object
              response:
                synthesize:
                  prompt: "Generate a plausible response"
  expected:
    valid: true

- name: "V-033 invalid: MCP tool response with content and synthesize"
  id: VAL-033b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: "test"
              description: "A test tool"
              inputSchema:
                type: object
              response:
                content:
                  - type: text
                    text: "static"
                synthesize:
                  prompt: "Generate a plausible response"
  expected:
    errors:
      - rule: "V-033"
        path: "attack.execution.state.tools[0].response"

# ---------------------------------------------------------------------------
# V-034: At most one catch-all response entry (omitting when)
# ---------------------------------------------------------------------------

- name: "V-034 valid: responses with one catch-all at end"
  id: VAL-034a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: "test"
              description: "A test tool"
              inputSchema:
                type: object
              responses:
                - when:
                    arguments.command: "safe"
                  content:
                    - type: text
                      text: "safe response"
                - content:
                    - type: text
                      text: "default response"
  expected:
    valid: true

- name: "V-034 invalid: responses with two entries both omitting when"
  id: VAL-034b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: "test"
              description: "A test tool"
              inputSchema:
                type: object
              responses:
                - content:
                    - type: text
                      text: "first default"
                - content:
                    - type: text
                      text: "second default"
  expected:
    errors:
      - rule: "V-034"
        path: "attack.execution.state.tools[0].responses"

# ---------------------------------------------------------------------------
# V-035: synthesize.prompt non-empty string
# ---------------------------------------------------------------------------

- name: "V-035 valid: synthesize with non-empty prompt"
  id: VAL-035a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: "test"
              description: "A test tool"
              inputSchema:
                type: object
              response:
                synthesize:
                  prompt: "Generate a convincing response"
  expected:
    valid: true

- name: "V-035 invalid: synthesize with empty prompt"
  id: VAL-035b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: "test"
              description: "A test tool"
              inputSchema:
                type: object
              response:
                synthesize:
                  prompt: ""
  expected:
    errors:
      - rule: "V-035"
        path: "attack.execution.state.tools[0].response.synthesize.prompt"

# ---------------------------------------------------------------------------
# Multi-error: document violating multiple rules simultaneously
# ---------------------------------------------------------------------------

- name: "Multiple violations: empty indicators, duplicate phase names"
  id: VAL-MULTI-001
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: setup
            state:
              tools: []
            trigger:
              event: tools/call
          - name: setup
            description: "Duplicate phase name."
      indicators: []
  expected:
    errors:
      - rule: "V-006"
        path: "attack.indicators"
      - rule: "V-011"
        path: "attack.execution.phases[1].name"

# ---------------------------------------------------------------------------
# V-037: attack.version, when present, MUST be a positive integer (>= 1)
# ---------------------------------------------------------------------------

- name: "V-037 valid: version is 1"
  id: VAL-037a
  input: |
    oatf: "0.1"
    attack:
      version: 1
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-037 valid: version is large positive integer"
  id: VAL-037b
  input: |
    oatf: "0.1"
    attack:
      version: 99
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-037 invalid: version is 0"
  id: VAL-037c
  input: |
    oatf: "0.1"
    attack:
      version: 0
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-037"
        path: "attack.version"

- name: "V-037 invalid: version is negative"
  id: VAL-037d
  input: |
    oatf: "0.1"
    attack:
      version: -1
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-037"
        path: "attack.version"

# ---------------------------------------------------------------------------
# V-038: trigger.after, when present, MUST be a valid duration
# ---------------------------------------------------------------------------

- name: "V-038 valid: shorthand duration"
  id: VAL-038a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            trigger:
              after: 30s
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-038 valid: ISO 8601 duration"
  id: VAL-038b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            trigger:
              after: PT1H30M
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-038 invalid: malformed duration"
  id: VAL-038c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            trigger:
              after: "not-a-duration"
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-038"
        path: "attack.execution.phases[1].trigger.after"

# ---------------------------------------------------------------------------
# V-039: Extractor names MUST match [a-z][a-z0-9_]*
# ---------------------------------------------------------------------------

- name: "V-039 valid: lowercase extractor name with underscores"
  id: VAL-039a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            extractors:
              - name: tool_name
                source: request
                type: json_path
                selector: "$.name"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-039 invalid: extractor name with uppercase"
  id: VAL-039b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            extractors:
              - name: ToolName
                source: request
                type: json_path
                selector: "$.name"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-039"
        path: "attack.execution.phases[0].extractors[0].name"

- name: "V-039 invalid: extractor name starting with digit"
  id: VAL-039c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            extractors:
              - name: 1tool
                source: request
                type: json_path
                selector: "$.name"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-039"
        path: "attack.execution.phases[0].extractors[0].name"

# ---------------------------------------------------------------------------
# V-040: phase.extractors, when present, MUST contain at least one entry
# ---------------------------------------------------------------------------

- name: "V-040 invalid: empty extractors array"
  id: VAL-040a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            extractors: []
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-040"
        path: "attack.execution.phases[0].extractors"

# ---------------------------------------------------------------------------
# V-041: expression.variables keys must be valid CEL identifiers
# ---------------------------------------------------------------------------

- name: "V-041 valid: variables key is a valid CEL identifier"
  id: VAL-041a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "size(tools) > 0"
            variables:
              tools: "tools"
  expected:
    valid: true

- name: "V-041 invalid: variables key contains a hyphen"
  id: VAL-041b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "true"
            variables:
              my-var: "tools"
  expected:
    errors:
      - rule: "V-041"
        path: "attack.indicators[0].expression.variables.my-var"

- name: "V-041 invalid: variables key contains a dot"
  id: VAL-041c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "true"
            variables:
              my.var: "tools"
  expected:
    errors:
      - rule: "V-041"
        path: "attack.indicators[0].expression.variables.my.var"

- name: "V-041 valid: underscore-prefixed identifier"
  id: VAL-041d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "_tools != null"
            variables:
              _tools: "tools"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-042: trigger must specify at least one of event or after
# ---------------------------------------------------------------------------

- name: "V-042 valid: trigger with event only"
  id: VAL-042a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-042 valid: trigger with after only"
  id: VAL-042b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              after: 30s
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-042 invalid: empty trigger object"
  id: VAL-042c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger: {}
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-042"
        path: "attack.execution.phases[0].trigger"

# ---------------------------------------------------------------------------
# V-043: binding-specific action objects must have exactly one non-x- key
# ---------------------------------------------------------------------------

- name: "V-043 valid: known action send_notification"
  id: VAL-043a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            on_enter:
              - send_notification:
                  method: "notifications/tools/list_changed"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-043 invalid: action object with two non-x- keys"
  id: VAL-043b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            on_enter:
              - send_notification:
                  method: "notifications/tools/list_changed"
                log:
                  message: "Triggered"
                  level: info
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-043"
        path: "attack.execution.phases[0].on_enter[0]"

- name: "V-043 valid: binding-specific action with single custom key"
  id: VAL-043c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            on_enter:
              - custom_action:
                  param: "value"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-043 valid: action with x- extension key alongside action key"
  id: VAL-043d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            on_enter:
              - send_notification:
                  method: "notifications/tools/list_changed"
                x-metadata: "extra info"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-044: regex extractor selectors must contain at least one capture group
# ---------------------------------------------------------------------------

- name: "V-044 valid: regex extractor with capture group"
  id: VAL-044a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            extractors:
              - name: token
                source: request
                type: regex
                selector: '"token":\s*"([^"]+)"'
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-044 invalid: regex extractor without capture group"
  id: VAL-044b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            extractors:
              - name: token
                source: request
                type: regex
                selector: "passwd"
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-044"
        path: "attack.execution.phases[0].extractors[0].selector"

# ---------------------------------------------------------------------------
# V-045: phase.on_enter must contain at least one action when present
# ---------------------------------------------------------------------------

- name: "V-045 invalid: phase.on_enter is an empty array"
  id: VAL-045a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            on_enter: []
            trigger:
              event: tools/call
          - name: terminal
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-045"
        path: "attack.execution.phases[0].on_enter"
