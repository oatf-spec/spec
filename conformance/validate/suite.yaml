# =============================================================================
# OATF Conformance: Validation Test Suite
# Tests SDK validate() entry point against rules from ยง11.1.
# =============================================================================

# ---------------------------------------------------------------------------
# V-001: oatf field is present and is a supported version string
# ---------------------------------------------------------------------------

- name: "V-001 valid: oatf field present with supported version"
  id: VAL-001a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-001 invalid: oatf field missing"
  id: VAL-001b
  input: |
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-001"
        path: "oatf"

- name: "V-001 invalid: unsupported version string"
  id: VAL-001c
  input: |
    oatf: "9.9"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-001"
        path: "oatf"

# ---------------------------------------------------------------------------
# V-002: oatf field is the first field in the document
# ---------------------------------------------------------------------------

- name: "V-002 valid: oatf is the first field"
  id: VAL-002a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-002 invalid: attack appears before oatf"
  id: VAL-002b
  input: |
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
    oatf: "0.1"
  expected:
    errors:
      - rule: "V-002"
        path: "oatf"

# ---------------------------------------------------------------------------
# V-003: Exactly one attack object is present
# ---------------------------------------------------------------------------

- name: "V-003 valid: exactly one attack object"
  id: VAL-003a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-003 invalid: attack is an array instead of object"
  id: VAL-003b
  input: |
    oatf: "0.1"
    attack:
      - id: OATF-TEST-001
        name: "Attack One"
      - id: OATF-TEST-002
        name: "Attack Two"
  expected:
    errors:
      - rule: "V-003"
        path: "attack"

# ---------------------------------------------------------------------------
# V-004: Required fields present (only execution is required)
# ---------------------------------------------------------------------------

- name: "V-004 valid: minimal document with only execution"
  id: VAL-004a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
  expected:
    valid: true

- name: "V-004 valid: missing attack.id (now optional)"
  id: VAL-004b
  input: |
    oatf: "0.1"
    attack:
      name: "Test Attack"
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 valid: missing attack.name (now optional)"
  id: VAL-004c
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 valid: missing attack.description (now optional)"
  id: VAL-004d
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 valid: missing severity (now optional)"
  id: VAL-004e
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-004 invalid: missing execution"
  id: VAL-004f
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      severity: high
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-004"
        path: "attack.execution"

- name: "V-004 valid: missing indicators (now optional)"
  id: VAL-004g
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      severity: high
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-005: All enumeration values are valid
# ---------------------------------------------------------------------------

- name: "V-005 valid: all enumeration values are valid"
  id: VAL-005a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      severity: high
      status: experimental
      execution:
        mode: mcp_server
        state:
          tools:
            - name: test-tool
              description: "A test tool"
              inputSchema:
                type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-005 invalid: severity level 'extreme' is not a valid enum value"
  id: VAL-005b
  input: |
    oatf: "0.1"
    attack:
      severity: extreme
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.severity"

- name: "V-005 invalid: execution.mode does not match pattern"
  id: VAL-005c
  input: |
    oatf: "0.1"
    attack:
      severity: high
      execution:
        mode: grpc_attacker
        phases:
          - name: phase-1
            state:
              tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.execution.mode"

- name: "V-005 invalid: execution.mode missing _{role} suffix"
  id: VAL-005d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp
        state:
          tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.execution.mode"

- name: "V-005 invalid: status 'published' is not a valid enum value"
  id: VAL-005e
  input: |
    oatf: "0.1"
    attack:
      severity: high
      status: published
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-005"
        path: "attack.status"

- name: "V-005 invalid: indicator surface 'invalid_surface' for MCP protocol"
  id: VAL-005f
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: invalid_surface
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-005"
        path: "attack.indicators[0].surface"

- name: "V-005 invalid: correlation.logic 'majority' is not a valid enum value"
  id: VAL-005g
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
      correlation:
        logic: majority
  expected:
    errors:
      - rule: "V-005"
        path: "attack.correlation.logic"

- name: "V-005 invalid: indicator has no detection key"
  id: VAL-005h
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

# ---------------------------------------------------------------------------
# V-006: indicators contains at least one entry when present
# ---------------------------------------------------------------------------

- name: "V-006 invalid: indicators is empty array"
  id: VAL-006a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators: []
  expected:
    errors:
      - rule: "V-006"
        path: "attack.indicators"

# ---------------------------------------------------------------------------
# V-007: execution.phases contains at least one entry
# ---------------------------------------------------------------------------

- name: "V-007 invalid: execution.phases is empty array"
  id: VAL-007a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-007"
        path: "attack.execution.phases"

# ---------------------------------------------------------------------------
# V-008: At most one terminal phase, and it is the last phase
# ---------------------------------------------------------------------------

- name: "V-008 valid: terminal phase is the last phase"
  id: VAL-008a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            description: "Terminal phase, no trigger."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-008 invalid: terminal phase is first, non-terminal follows"
  id: VAL-008b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
          - name: phase-2
            trigger:
              event: tools/call
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-008"
        path: "attack.execution.phases[0]"

- name: "V-008 invalid: two terminal phases (neither has trigger)"
  id: VAL-008c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
            trigger:
              event: tools/call
          - name: phase-2
            description: "First terminal phase."
          - name: phase-3
            description: "Second terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-008"
        path: "attack.execution.phases"

- name: "V-008 valid: single phase with no trigger (terminal-only document)"
  id: VAL-008d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: only-phase
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-009: First phase includes state
# ---------------------------------------------------------------------------

- name: "V-009 valid: first phase has state"
  id: VAL-009a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-009 invalid: first phase omits state"
  id: VAL-009b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            description: "No state defined."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-009"
        path: "attack.execution.phases[0]"

# ---------------------------------------------------------------------------
# V-010: All explicitly specified indicator.id values are unique
# ---------------------------------------------------------------------------

- name: "V-010 valid: all indicator IDs unique"
  id: VAL-010a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: IND-01
          surface: tool_description
          pattern:
            contains: "test"
        - id: IND-02
          surface: tool_name
          pattern:
            contains: "evil"
  expected:
    valid: true

- name: "V-010 invalid: duplicate indicator IDs"
  id: VAL-010b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - id: IND-01
          surface: tool_description
          pattern:
            contains: "test"
        - id: IND-01
          surface: tool_name
          pattern:
            contains: "evil"
  expected:
    errors:
      - rule: "V-010"
        path: "attack.indicators[1].id"

# ---------------------------------------------------------------------------
# V-011: All phase.name values are unique
# ---------------------------------------------------------------------------

- name: "V-011 valid: all phase names unique"
  id: VAL-011a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: setup
            state:
              tools: []
            trigger:
              event: tools/call
          - name: exploit
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-011 invalid: two phases named 'setup'"
  id: VAL-011b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: setup
            state:
              tools: []
            trigger:
              event: tools/call
          - name: setup
            description: "Duplicate name."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-011"
        path: "attack.execution.phases[1].name"

# ---------------------------------------------------------------------------
# V-012: Each indicator has exactly one detection key (pattern/expression/semantic)
# ---------------------------------------------------------------------------

- name: "V-012 valid: indicator has pattern key"
  id: VAL-012a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-012 invalid: indicator has both pattern and expression keys"
  id: VAL-012b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
          expression:
            cel: "true"
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

- name: "V-012 invalid: indicator has both pattern and semantic keys"
  id: VAL-012c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
          semantic:
            intent: "detect injection"
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

- name: "V-012 invalid: indicator with no detection key at all"
  id: VAL-012d
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
  expected:
    errors:
      - rule: "V-012"
        path: "attack.indicators[0]"

# ---------------------------------------------------------------------------
# V-013: All regular expressions are syntactically valid RE2
# ---------------------------------------------------------------------------

- name: "V-013 valid: regex pattern is syntactically valid"
  id: VAL-013a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            regex: "id_rsa|passwd"
  expected:
    valid: true

- name: "V-013 invalid: regex with unclosed character class"
  id: VAL-013b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            regex: "[unclosed"
  expected:
    errors:
      - rule: "V-013"
        path: "attack.indicators[0].pattern.regex"

- name: "V-013 invalid: regex in trigger.match predicate is also validated"
  id: VAL-013c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              event: tools/call
              match:
                arguments.command:
                  regex: "[unclosed"
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-013"
        path: "attack.execution.phases[0].trigger.match.arguments.command.regex"

# ---------------------------------------------------------------------------
# V-014: All CEL expressions are syntactically valid
# ---------------------------------------------------------------------------

- name: "V-014 valid: well-formed CEL expression"
  id: VAL-014b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "message.tools.exists(t, size(t.description) > 100)"
  expected:
    valid: true

- name: "V-014 invalid: CEL expression with unclosed parenthesis"
  id: VAL-014a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          expression:
            cel: "size(message.tools"
  expected:
    errors:
      - rule: "V-014"
        path: "attack.indicators[0].expression.cel"

# ---------------------------------------------------------------------------
# V-015: All JSONPath expressions are syntactically valid
# ---------------------------------------------------------------------------

- name: "V-015 valid: well-formed JSONPath expression"
  id: VAL-015b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            extractors:
              - name: tool_name
                source: request
                type: json_path
                selector: "$.tools[0].name"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-015 invalid: JSONPath with unclosed bracket"
  id: VAL-015a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            extractors:
              - name: broken_path
                source: request
                type: json_path
                selector: "$.tools["
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-015"
        path: "attack.execution.phases[0].extractors[0].selector"

# ---------------------------------------------------------------------------
# V-016: All template references use valid syntax
# ---------------------------------------------------------------------------

- name: "V-016 valid: well-formed template reference"
  id: VAL-016a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
                  response:
                    content:
                      - type: text
                        text: "Result for {{request.arguments.query}}"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-016 invalid: unclosed template reference"
  id: VAL-016b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
                  response:
                    content:
                      - type: text
                        text: "Result for {{unclosed"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-016"
        path: "attack.execution.phases[0].state.tools[0].response.content[0].text"

- name: "V-016 valid: escaped template is not flagged"
  id: VAL-016c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools:
                - name: test-tool
                  description: "A test tool"
                  inputSchema:
                    type: object
                  response:
                    content:
                      - type: text
                        text: "Literal \\{{not_a_template}} here"
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-019: severity.confidence is in range 0-100
# ---------------------------------------------------------------------------

- name: "V-019 valid: severity.confidence is 75"
  id: VAL-019a
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: 75
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-019 invalid: severity.confidence is -1 (below range)"
  id: VAL-019b
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: -1
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-019"
        path: "attack.severity.confidence"

- name: "V-019 invalid: severity.confidence is 101 (above range)"
  id: VAL-019c
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: 101
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    errors:
      - rule: "V-019"
        path: "attack.severity.confidence"

- name: "V-019 valid: severity.confidence at lower boundary (0)"
  id: VAL-019d
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: low
        confidence: 0
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-019 valid: severity.confidence at upper boundary (100)"
  id: VAL-019e
  input: |
    oatf: "0.1"
    attack:
      severity:
        level: high
        confidence: 100
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

# ---------------------------------------------------------------------------
# V-021: Indicator surface is valid for the indicator's resolved protocol
# ---------------------------------------------------------------------------

- name: "V-021 valid: MCP indicator with MCP surface"
  id: VAL-021a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-021 invalid: MCP execution with A2A surface agent_card"
  id: VAL-021b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
      indicators:
        - surface: agent_card
          pattern:
            contains: "malicious"
  expected:
    errors:
      - rule: "V-021"
        path: "attack.indicators[0].surface"

# ---------------------------------------------------------------------------
# V-022: Trigger count and match only present when event is also present
# ---------------------------------------------------------------------------

- name: "V-022 invalid: trigger has count but no event"
  id: VAL-022a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              count: 3
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-022"
        path: "attack.execution.phases[0].trigger"

- name: "V-022 invalid: trigger has match but no event"
  id: VAL-022b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
            trigger:
              match:
                arguments.command: "run"
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-022"
        path: "attack.execution.phases[0].trigger"

# ---------------------------------------------------------------------------
# V-033: Execution form mutual exclusivity (state/phases/actors)
# ---------------------------------------------------------------------------

- name: "V-033 invalid: both state and phases present"
  id: VAL-033a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
        phases:
          - name: phase-1
            state:
              tools: []
  expected:
    errors:
      - rule: "V-033"
        path: "attack.execution"

- name: "V-033 invalid: both state and actors present"
  id: VAL-033b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
        actors:
          - name: default
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
  expected:
    errors:
      - rule: "V-033"
        path: "attack.execution"

- name: "V-033 invalid: both phases and actors present"
  id: VAL-033c
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: phase-1
            state:
              tools: []
        actors:
          - name: default
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
  expected:
    errors:
      - rule: "V-033"
        path: "attack.execution"

# ---------------------------------------------------------------------------
# V-034: Multi-actor constraints
# ---------------------------------------------------------------------------

- name: "V-034 valid: actors with unique names and modes"
  id: VAL-034a
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: attacker
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
          - name: observer
            mode: a2a_server
            phases:
              - name: phase-1
                state:
                  agent_card:
                    name: "Agent"
                    description: "An agent"
                    url: "https://example.com"
                    skills: []
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    valid: true

- name: "V-034 invalid: duplicate actor names"
  id: VAL-034b
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: attacker
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
          - name: attacker
            mode: a2a_server
            phases:
              - name: phase-1
                state:
                  agent_card:
                    name: "Agent"
                    description: "An agent"
                    url: "https://example.com"
                    skills: []
      indicators:
        - protocol: mcp
          surface: tool_description
          pattern:
            contains: "test"
  expected:
    errors:
      - rule: "V-034"
        path: "attack.execution.actors[1].name"

- name: "V-034 invalid: actor name does not match pattern"
  id: VAL-034c
  input: |
    oatf: "0.1"
    attack:
      execution:
        actors:
          - name: "Invalid-Name"
            mode: mcp_server
            phases:
              - name: phase-1
                state:
                  tools: []
  expected:
    errors:
      - rule: "V-034"
        path: "attack.execution.actors[0].name"

# ---------------------------------------------------------------------------
# V-039: Mode pattern validation
# ---------------------------------------------------------------------------

- name: "V-039 valid: standard mode pattern"
  id: VAL-039a
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        state:
          tools: []
  expected:
    valid: true

- name: "V-039 valid: unknown but valid mode pattern"
  id: VAL-039b
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: custom_proto_server
        state:
          tools: []
  expected:
    valid: true

# ---------------------------------------------------------------------------
# Multi-error: document violating multiple rules simultaneously
# ---------------------------------------------------------------------------

- name: "Multiple violations: empty indicators, duplicate phase names"
  id: VAL-MULTI-001
  input: |
    oatf: "0.1"
    attack:
      execution:
        mode: mcp_server
        phases:
          - name: setup
            state:
              tools: []
            trigger:
              event: tools/call
          - name: setup
            description: "Duplicate phase name."
      indicators: []
  expected:
    errors:
      - rule: "V-006"
        path: "attack.indicators"
      - rule: "V-011"
        path: "attack.execution.phases[1].name"
