# =============================================================================
# OATF Conformance: evaluate_extractor Primitive Tests
# Tests SDK evaluate_extractor(extractor, message) per SDK spec ยง5.6.
# =============================================================================

- name: "JSONPath match returns first result"
  id: EXTR-001
  input:
    extractor:
      name: "tool_name"
      source: "request"
      type: "json_path"
      selector: "$.tools[0].name"
    message:
      tools:
        - name: "calc"

  expected: "calc"

- name: "JSONPath no match returns null"
  id: EXTR-002
  input:
    extractor:
      name: "missing"
      source: "request"
      type: "json_path"
      selector: "$.missing"
    message:
      other: 1

  expected: null

- name: "Regex with capture group returns first group"
  id: EXTR-003
  input:
    extractor:
      name: "api_key"
      source: "response"
      type: "regex"
      selector: "key=([a-zA-Z0-9]+)"
    message: "api key=abc123 here"

  expected: "abc123"

- name: "Regex no match returns null"
  id: EXTR-004
  input:
    extractor:
      name: "secret"
      source: "response"
      type: "regex"
      selector: "secret=(\\w+)"
    message: "no secrets"

  expected: null

- name: "JSONPath match on nested array element"
  id: EXTR-005
  input:
    extractor:
      name: "first_arg_name"
      source: "request"
      type: "json_path"
      selector: "$.arguments.files[0]"
    message:
      arguments:
        files:
          - "/etc/passwd"
          - "/etc/shadow"

  expected: "/etc/passwd"

- name: "Regex with multiple capture groups returns first group"
  id: EXTR-006
  input:
    extractor:
      name: "domain"
      source: "response"
      type: "regex"
      selector: "https?://([^/]+)(/.*)"
    message: "visit https://evil.com/exfil?data=secret"

  expected: "evil.com"

- name: "JSONPath match on non-scalar serializes to compact JSON"
  id: EXTR-008
  input:
    extractor:
      name: "schema"
      source: "request"
      type: "json_path"
      selector: "$.tools[0].inputSchema"
    message:
      tools:
        - inputSchema:
            type: "object"
            properties:
              a:
                type: "string"

  expected: '{"type":"object","properties":{"a":{"type":"string"}}}'

- name: "Regex match without capture group returns null"
  id: EXTR-009
  input:
    extractor:
      name: "has_key"
      source: "response"
      type: "regex"
      selector: "key=[a-zA-Z0-9]+"
    message: "api key=abc123 here"

  expected: null

- name: "JSONPath with wildcard selector returns first match"
  id: EXTR-007
  input:
    extractor:
      name: "any_tool"
      source: "request"
      type: "json_path"
      selector: "$.tools[*].name"
    message:
      tools:
        - name: "first"
        - name: "second"

  expected: "first"
