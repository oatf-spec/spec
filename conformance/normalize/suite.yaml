# =============================================================================
# OATF Conformance: Normalization Test Suite
# Tests SDK normalize() entry point against steps N-001 through N-008.
#
# Every expected output is fully normalized â€” all eight N-rules applied
# simultaneously. Test runners compare the actual normalize() result
# against expected structurally, not as string equality.
# =============================================================================

# ---------------------------------------------------------------------------
# N-001: Default values
# ---------------------------------------------------------------------------

- name: "N-001 version: omitted version defaults to 1.0.0"
  id: NORM-001a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-001 status: omitted status defaults to draft"
  id: NORM-001b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "2.0.0"
      description: "A test attack."
      severity: low
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "2.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: low
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-001 confidence: severity object without confidence defaults to 50"
  id: NORM-001c
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity:
        level: critical
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: critical
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-001 indicator protocol: omitted protocol inherits execution.protocol"
  id: NORM-001d
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: medium
      execution:
        protocol: a2a
        role: server
        phases:
          - name: phase-1
            state:
              agent_card:
                name: "Test Agent"
                description: "A test agent."
                url: "https://example.com"
                skills: []
      indicators:
        - surface: skill_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: medium
        confidence: 50
      classification:
        protocols:
          - a2a
      execution:
        protocol: a2a
        role: server
        phases:
          - name: phase-1
            state:
              agent_card:
                name: "Test Agent"
                description: "A test agent."
                url: "https://example.com"
                skills: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: a2a
          surface: skill_description
          method: pattern
          pattern:
            target: "skills[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-001 indicator_logic: omitted indicator_logic defaults to any"
  id: NORM-001e
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-002: Severity scalar expansion
# ---------------------------------------------------------------------------

- name: "N-002 severity scalar 'high' expands to object form"
  id: NORM-002a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-002 severity scalar 'informational' expands to object form"
  id: NORM-002b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: informational
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: informational
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-003: Indicator ID auto-generation
# ---------------------------------------------------------------------------

- name: "N-003 single indicator without id gets OATF-TEST-001-01"
  id: NORM-003a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-003 three indicators without ids get sequential IDs"
  id: NORM-003b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
        - surface: tool_name
          pattern:
            contains: "evil"
        - surface: tool_response
          pattern:
            contains: "exfil"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
        - id: OATF-TEST-001-02
          protocol: mcp
          surface: tool_name
          method: pattern
          pattern:
            target: "tools[*].name"
            condition:
              contains: "evil"
            scope: value
        - id: OATF-TEST-001-03
          protocol: mcp
          surface: tool_response
          method: pattern
          pattern:
            target: "content[*]"
            condition:
              contains: "exfil"
            scope: value
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-004: Protocol inference for classification.protocols
# ---------------------------------------------------------------------------

- name: "N-004 classification omitted, single protocol inferred from execution"
  id: NORM-004a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-004 protocols inferred from execution.protocol and phase override"
  id: NORM-004b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
            advance:
              event: tools/call
          - name: phase-2
            protocol: a2a
            role: peer
            state:
              agent_card:
                name: "Agent"
                description: "Agent"
                url: "https://example.com"
                skills: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
          - a2a
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
            advance:
              event: tools/call
              count: 1
          - name: phase-2
            protocol: a2a
            role: peer
            state:
              agent_card:
                name: "Agent"
                description: "Agent"
                url: "https://example.com"
                skills: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-004 protocols inferred from execution.protocol and indicator protocol override"
  id: NORM-004c
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
        - protocol: ag_ui
          surface: message_history
          pattern:
            contains: "injected"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
          - ag_ui
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
        - id: OATF-TEST-001-02
          protocol: ag_ui
          surface: message_history
          method: pattern
          pattern:
            target: "messages[*]"
            condition:
              contains: "injected"
            scope: value
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-005: Target resolution from surface registry
# ---------------------------------------------------------------------------

- name: "N-005 pattern target resolved from surface tool_description"
  id: NORM-005a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-005 schema target resolved from surface agent_card_name"
  id: NORM-005b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: a2a
        role: server
        phases:
          - name: phase-1
            state:
              agent_card:
                name: "Evil Agent"
                description: "An evil agent."
                url: "https://example.com"
                skills: []
      indicators:
        - surface: agent_card_name
          schema:
            checks:
              - type: max_length
                max: 80
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - a2a
      execution:
        protocol: a2a
        role: server
        phases:
          - name: phase-1
            state:
              agent_card:
                name: "Evil Agent"
                description: "An evil agent."
                url: "https://example.com"
                skills: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: a2a
          surface: agent_card_name
          method: schema
          schema:
            target: "name"
            checks:
              - type: max_length
                max: 80
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-006: Pattern shorthand expansion
# ---------------------------------------------------------------------------

- name: "N-006 pattern shorthand expands to standard form with condition wrapper"
  id: NORM-006a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "malicious"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "malicious"
            scope: value
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-007: Method inference from present key
# ---------------------------------------------------------------------------

- name: "N-007 indicator method inferred from pattern key"
  id: NORM-007a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

# ---------------------------------------------------------------------------
# N-008: Trigger count default
# ---------------------------------------------------------------------------

- name: "N-008 trigger with event but no count gets count: 1"
  id: NORM-008a
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
            advance:
              event: tools/call
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
            advance:
              event: tools/call
              count: 1
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any

- name: "N-008 trigger with event and explicit count: 3 is preserved"
  id: NORM-008b
  input: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      description: "A test attack."
      severity: high
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
            advance:
              event: tools/call
              count: 3
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - surface: tool_description
          pattern:
            contains: "test"
  expected: |
    oatf: "0.1"
    attack:
      id: OATF-TEST-001
      name: "Test Attack"
      version: "1.0.0"
      status: draft
      description: "A test attack."
      severity:
        level: high
        confidence: 50
      classification:
        protocols:
          - mcp
      execution:
        protocol: mcp
        role: server
        phases:
          - name: phase-1
            state:
              tools: []
            advance:
              event: tools/call
              count: 3
          - name: phase-2
            description: "Terminal phase."
      indicators:
        - id: OATF-TEST-001-01
          protocol: mcp
          surface: tool_description
          method: pattern
          pattern:
            target: "tools[*].description"
            condition:
              contains: "test"
            scope: value
      indicator_logic: any
